{% extends "base.html" %}

{% block title %}AI Assistant - IT Support Agent{% endblock %}

{% block extra_head %}
<style>
    .chat-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #495057;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #1a1e23 !important;
    }
    
    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.375rem;
        max-width: 80%;
        display: block;
        clear: both;
    }
    
    .message.user {
        background-color: #0d6efd;
        color: white;
        margin-left: auto;
        margin-right: 0;
        float: right;
    }
    
    .message.assistant {
        background-color: #343a40;
        border: 1px solid #495057;
        color: #f8f9fa;
        margin-left: 0;
        margin-right: auto;
        float: left;
    }
    
    .message-header {
        font-weight: bold;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        color: #adb5bd;
    }
    
    .message-content {
        white-space: pre-wrap;
        line-height: 1.4;
        color: #f8f9fa;
    }
    
    .citations {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #495057;
        font-size: 0.875rem;
        color: #adb5bd;
    }
    
    .citation {
        display: inline-block;
        background-color: #495057;
        color: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        margin-right: 0.5rem;
        margin-bottom: 0.25rem;
    }
    
    .loading {
        display: none;
    }
    
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 0.5rem;
        color: #adb5bd;
        font-style: italic;
    }
    
    .typing-dots {
        display: flex;
        gap: 0.25rem;
    }
    
    .typing-dots span {
        height: 8px;
        width: 8px;
        background-color: #adb5bd;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
    }
    
    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }
    
    /* Dark mode card styling */
    .card {
        background-color: #212529 !important;
        border-color: #495057;
    }
    
    .card-header {
        background-color: #343a40 !important;
        border-color: #495057;
        color: #f8f9fa;
    }
    
    .card-body {
        background-color: #212529 !important;
        color: #f8f9fa;
    }
    
    /* Form controls dark mode */
    .form-control {
        background-color: #343a40;
        border-color: #495057;
        color: #f8f9fa;
    }
    
    .form-control:focus {
        background-color: #343a40;
        border-color: #0d6efd;
        color: #f8f9fa;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .form-control::placeholder {
        color: #adb5bd;
    }
    
    /* Button styling */
    .btn-outline-primary {
        color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: #fff;
    }
    
    .btn-outline-secondary {
        color: #6c757d;
        border-color: #6c757d;
    }
    
    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: #fff;
    }
    
    /* Modal dark mode */
    .modal-content {
        background-color: #212529;
        border-color: #495057;
    }
    
    .modal-header {
        border-color: #495057;
        color: #f8f9fa;
    }
    
    .modal-body {
        color: #f8f9fa;
    }
    
    .modal-footer {
        border-color: #495057;
    }
    
    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    
    /* Text colors */
    .text-muted {
        color: #adb5bd !important;
    }
    
    .text-start {
        color: #f8f9fa;
    }
    
    /* Welcome message styling */
    .message.assistant:first-child {
        background: linear-gradient(135deg, #343a40, #495057);
        border-color: #0d6efd;
    }
    
    /* Force dark background for chat container */
    #chatContainer {
        background-color: #1a1e23 !important;
    }
    
    .card-body.p-0 {
        background-color: #212529 !important;
    }
    
    /* Target the specific white container area */
    .chat-container,
    .chat-container *,
    .card-body,
    .card-body *,
    .p-3,
    .border-top,
    .input-group,
    .form-control {
        background-color: #1a1e23 !important;
    }
    
    /* Override Bootstrap white backgrounds */
    .bg-white,
    .bg-light {
        background-color: #1a1e23 !important;
    }
    
    /* Force all white backgrounds to dark */
    .container-fluid,
    .container,
    .row,
    .col,
    .col-lg-8,
    .col-lg-4,
    .col-12,
    .p-3,
    .p-4,
    .border-top,
    .border-secondary,
    .input-group,
    .d-grid,
    .gap-2,
    .mt-3,
    .mb-4,
    .d-flex,
    .align-items-center,
    .justify-content-between,
    main {
        background-color: transparent !important;
    }
    
    /* Override any remaining white backgrounds */
    body,
    html {
        background-color: #0d1117 !important;
    }
    
    /* Glass effect dark override */
    .glass-effect {
        background: rgba(33, 37, 41, 0.8) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Icon circle dark mode */
    .icon-circle {
        background-color: #17a2b8 !important;
    }
    
    /* Additional dark overrides for any missed elements */
    * {
        border-color: #495057 !important;
    }
    
    .text-light,
    .text-muted,
    p,
    h1,
    h5,
    span,
    div {
        color: #f8f9fa !important;
    }
    
    .text-muted {
        color: #adb5bd !important;
    }
    
    /* Nuclear option - force everything to dark */
    .chat-container,
    .chat-container > *,
    .chat-container > * > *,
    .chat-container > * > * > *,
    .card,
    .card *,
    .card-body,
    .card-body *,
    div,
    form,
    input {
        background-color: #1a1e23 !important;
        background: #1a1e23 !important;
    }
    
    /* Specific input styling */
    input.form-control {
        background-color: #343a40 !important;
        background: #343a40 !important;
        color: #f8f9fa !important;
        border: 1px solid #495057 !important;
    }
    
    /* Message styling override */
    .message.user {
        background-color: #0d6efd !important;
        background: #0d6efd !important;
    }
    
    .message.assistant {
        background-color: #343a40 !important;
        background: #343a40 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-effect rounded-3 p-4">
                <div class="d-flex align-items-center">
                    <div class="me-4">
                        <div class="icon-circle bg-info">
                            <i class="fas fa-robot fa-2x"></i>
                        </div>
                    </div>
                    <div>
                        <h1 class="display-6 mb-2">
                            <span class="gradient-text">AI IT Assistant</span>
                        </h1>
                        <p class="text-muted mb-0">
                            <i class="fas fa-brain me-1"></i>
                            Ask me anything about IT support! I can help with password resets, software installation, network issues, and more. I'll provide step-by-step guidance based on official IT policies.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-lg bg-dark border-secondary">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-comments me-2 text-info"></i> Chat with AI Assistant
                    </h5>
                    <button id="clearChat" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-trash me-1"></i> Clear Chat
                    </button>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Messages Container -->
                    <div id="chatContainer" class="chat-container">
                        <!-- Welcome Message -->
                        <div class="message assistant">
                            <div class="message-header">
                                <i class="fas fa-robot"></i> AI Assistant
                            </div>
                            <div class="message-content">
Hello! I'm your IT Support Assistant. I can help you with:

• Password reset procedures
• Software installation requests  
• Network troubleshooting
• General IT policies and procedures

What can I help you with today?
                            </div>
                        </div>
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div id="typingIndicator" class="typing-indicator p-3">
                        <i class="fas fa-robot"></i>
                        <span>AI Assistant is thinking</span>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    
                    <!-- Input Form -->
                    <div class="p-3 border-top border-secondary">
                        <form id="chatForm">
                            <div class="input-group">
                                <input type="text" id="messageInput" class="form-control" 
                                       placeholder="Type your IT question here..." 
                                       autocomplete="off" required>
                                <button type="submit" id="sendButton" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i> Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Examples -->
        <div class="col-lg-4">
            <div class="card shadow-lg bg-dark border-secondary">
                <div class="card-header border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-lightbulb me-2 text-warning"></i> Example Questions
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Click any example to try it:
                    </p>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm text-start example-question" 
                                data-question="I forgot my password and can't log into my email. What should I do?">
                            <i class="fas fa-key me-2"></i> Password Reset Help
                        </button>
                        
                        <button class="btn btn-outline-success btn-sm text-start example-question" 
                                data-question="I need to install new software for my work. What's the process?">
                            <i class="fas fa-download me-2"></i> Software Installation
                        </button>
                        
                        <button class="btn btn-outline-warning btn-sm text-start example-question" 
                                data-question="My internet is very slow and websites won't load properly. How can I fix this?">
                            <i class="fas fa-wifi me-2"></i> Network Issues
                        </button>
                        
                        <button class="btn btn-outline-info btn-sm text-start example-question" 
                                data-question="Can you help me understand the IT security policies?">
                            <i class="fas fa-shield-alt me-2"></i> Security Policies
                        </button>
                        
                        <button class="btn btn-outline-danger btn-sm text-start example-question" 
                                data-question="How do I submit a ticket for a computer hardware issue?">
                            <i class="fas fa-desktop me-2"></i> Hardware Support
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- AI Status -->
            <div class="card mt-3 shadow-lg bg-dark border-secondary">
                <div class="card-header border-secondary">
                    <h5 class="mb-0 text-light">
                        <i class="fas fa-info-circle me-2 text-info"></i> AI Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="aiStatus" class="d-flex align-items-center">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span class="text-light">Checking AI availability...</span>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Features:</strong><br>
                            • Policy-based guidance<br>
                            • Step-by-step instructions<br>
                            • Citation of sources<br>
                            • Approval level indicators
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.icon-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
</style>

<!-- Create Ticket Modal -->
<div class="modal fade" id="createTicketModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-light">Create Support Ticket</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ticketForm">
                    <div class="mb-3">
                        <label for="employeeName" class="form-label text-light">Your Name</label>
                        <input type="text" class="form-control" id="employeeName" required>
                    </div>
                    <div class="mb-3">
                        <label for="issueDescription" class="form-label text-light">Issue Description</label>
                        <textarea class="form-control" id="issueDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label text-light">Priority</label>
                        <select class="form-control" id="priority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitTicket">Create Ticket</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Chat functionality
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chatContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const aiStatus = document.getElementById('aiStatus');
    
    // Extract ticket_id from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const currentTicketId = urlParams.get('ticket_id');
    
    // Check AI status on page load
    checkAIStatus();
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            sendMessage(message);
        }
    });
    
    // Handle example questions
    document.querySelectorAll('.example-question').forEach(button => {
        button.addEventListener('click', function() {
            const question = this.dataset.question;
            messageInput.value = question;
            sendMessage(question);
        });
    });
    
    // Clear chat
    document.getElementById('clearChat').addEventListener('click', function() {
        const messages = chatContainer.querySelectorAll('.message:not(:first-child)');
        messages.forEach(msg => msg.remove());
    });
    
    async function sendMessage(message) {
        // Add user message to chat
        addMessage(message, 'user');
        
        // Clear input and disable form
        messageInput.value = '';
        setFormEnabled(false);
        showTypingIndicator();
        
        try {
            // Send request to AI agent
            const requestBody = {
                question: message
            };
            
            // Include ticket_id if available
            if (currentTicketId) {
                requestBody.ticket_id = parseInt(currentTicketId);
            }
            
            const response = await fetch('/api/agent/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Add AI response to chat
                addMessage(data.ai_response, 'assistant', data.citations);
                
                // Show option to create ticket if relevant
                if (shouldOfferTicketCreation(message, data.ai_response)) {
                    addTicketCreationOption(message);
                }
            } else {
                addMessage(`Sorry, I encountered an error: ${data.error}`, 'assistant');
            }
            
        } catch (error) {
            console.error('Error:', error);
            addMessage('Sorry, I\'m having trouble connecting right now. Please try again later or contact IT support directly.', 'assistant');
        }
        
        hideTypingIndicator();
        setFormEnabled(true);
        messageInput.focus();
    }
    
    function addMessage(content, sender, citations = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        headerDiv.innerHTML = sender === 'user' ? 
            '<i class="fas fa-user"></i> You' : 
            '<i class="fas fa-robot"></i> AI Assistant';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;
        
        messageDiv.appendChild(headerDiv);
        messageDiv.appendChild(contentDiv);
        
        // Add citations if provided
        if (citations && citations.length > 0) {
            const citationsDiv = document.createElement('div');
            citationsDiv.className = 'citations';
            citationsDiv.innerHTML = '<strong>Sources:</strong> ';
            
            citations.forEach(citation => {
                const citationSpan = document.createElement('span');
                citationSpan.className = 'citation';
                citationSpan.textContent = citation;
                citationsDiv.appendChild(citationSpan);
            });
            
            messageDiv.appendChild(citationsDiv);
        }
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function addTicketCreationOption(originalMessage) {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'message assistant';
        optionDiv.innerHTML = `
            <div class="message-header">
                <i class="fas fa-ticket-alt"></i> Create Ticket
            </div>
            <div class="message-content">
                Would you like me to help you create a support ticket for this issue?
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary create-ticket-btn" 
                            data-issue="${originalMessage}">
                        <i class="fas fa-plus"></i> Create Ticket
                    </button>
                </div>
            </div>
        `;
        
        chatContainer.appendChild(optionDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Add event listener to the create ticket button
        optionDiv.querySelector('.create-ticket-btn').addEventListener('click', function() {
            const issue = this.dataset.issue;
            document.getElementById('issueDescription').value = issue;
            new bootstrap.Modal(document.getElementById('createTicketModal')).show();
        });
    }
    
    function shouldOfferTicketCreation(question, response) {
        // Simple logic to determine if we should offer ticket creation
        const ticketKeywords = [
            'problem', 'issue', 'not working', 'broken', 'error', 
            'can\'t', 'cannot', 'unable', 'help', 'fix'
        ];
        
        return ticketKeywords.some(keyword => 
            question.toLowerCase().includes(keyword)
        );
    }
    
    function showTypingIndicator() {
        typingIndicator.style.display = 'flex';
    }
    
    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }
    
    function setFormEnabled(enabled) {
        messageInput.disabled = !enabled;
        sendButton.disabled = !enabled;
        
        if (enabled) {
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
        } else {
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        }
    }
    
    async function checkAIStatus() {
        try {
            const response = await fetch('/api/agent/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: 'test'
                })
            });
            
            if (response.ok) {
                aiStatus.innerHTML = `
                    <span class="text-success">
                        <i class="fas fa-check-circle"></i> AI Assistant is online
                    </span>
                `;
            } else {
                aiStatus.innerHTML = `
                    <span class="text-warning">
                        <i class="fas fa-exclamation-triangle"></i> AI Assistant is partially available
                    </span>
                `;
            }
        } catch (error) {
            aiStatus.innerHTML = `
                <span class="text-danger">
                    <i class="fas fa-times-circle"></i> AI Assistant is offline
                </span>
            `;
        }
    }
    
    // Handle ticket creation
    document.getElementById('submitTicket').addEventListener('click', async function() {
        const form = document.getElementById('ticketForm');
        const formData = new FormData(form);
        
        try {
            const response = await fetch('/api/tickets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    employee_name: document.getElementById('employeeName').value,
                    issue_description: document.getElementById('issueDescription').value,
                    priority: document.getElementById('priority').value
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('createTicketModal')).hide();
                addMessage(`Great! I've created ticket #${data.ticket_id} for you. You can track its progress in the tickets section.`, 'assistant');
                
                // Clear form
                form.reset();
            } else {
                alert('Error creating ticket: ' + data.error);
            }
            
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating ticket. Please try again.');
        }
    });
});
</script>
{% endblock %}
